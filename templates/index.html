<!DOCTYPE html>
<html>
<head>
    <title>Urban Advisor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        .leaflet-pane img, .leaflet-tile, .leaflet-marker-icon { max-width: none !important; max-height: none !important; }
        .leaflet-container { z-index: 0; }
        .station-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .leaflet-routing-container { display: none !important; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyAvaF6zCTFmv7-GvGdYdU6utqfYkC_8g9c",
            authDomain: "cs7ns4-assignment3-pylak.firebaseapp.com",
            databaseURL: "https://cs7ns4-assignment3-pylak-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cs7ns4-assignment3-pylak",
            storageBucket: "cs7ns4-assignment3-pylak.firebasestorage.app",
            messagingSenderId: "681832899411",
            appId: "1:681832899411:web:303dd6f28caffb7844f7a6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [user, setUser] = React.useState(null);
            if (!user) return <LoginScreen onLogin={setUser} />;
            return <Dashboard user={user} onLogout={() => setUser(null)} />;
        }

        function LoginScreen({ onLogin }) {
            const [email, setEmail] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const handleLogin = async (e) => {
                e.preventDefault();
                if(!email.includes("@")) return alert("Please enter a valid email address");
                setLoading(true);
                try {
                    await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    onLogin(email);
                } catch {}
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i className="fa-solid fa-city"></i></div>
                            <h1 className="text-3xl font-bold text-gray-800">Urban Advisor</h1>
                            <p className="text-gray-500 mt-2">Assignment 4 • Trinity College Dublin</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" required className="w-full p-3 border border-gray-300 rounded-lg" placeholder="student@tcd.ie" value={email} onChange={e => setEmail(e.target.value)} />
                            <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2">{loading ? <i className="fa-solid fa-circle-notch fa-spin"></i> : "Enter Dashboard"}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function BikeMap() {
            const mapRef = React.useRef(null);
            const mapInstance = React.useRef(null);
            const routingControlRef = React.useRef(null);
            const userLocationRef = React.useRef(null);
            const [stations, setStations] = React.useState([]);
            React.useEffect(() => {
                const ref = db.ref('live_map_stations');
                ref.on('value', (snapshot) => {
                    const val = snapshot.val();
                    const stationList = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
                    setStations(stationList);
                });
                return () => ref.off();
            }, []);
            React.useEffect(() => {
                if(!mapInstance.current && mapRef.current) {
                    mapInstance.current = L.map(mapRef.current, { minZoom: 4 }).setView([53.3498, -6.2603], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 19, noWrap: true }).addTo(mapInstance.current);
                    setTimeout(() => { mapInstance.current.invalidateSize(); }, 500);
                    const LocateControl = L.Control.extend({
                        options: { position: 'topleft' },
                        onAdd: function(map) {
                            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                            const btn = L.DomUtil.create('a', 'bg-white hover:bg-gray-100 flex items-center justify-center', container);
                            btn.innerHTML = '<i class="fa-solid fa-crosshairs text-gray-700"></i>';
                            btn.href = "#";
                            btn.style.width = '30px';
                            btn.style.height = '30px';
                            btn.onclick = function(e) { e.preventDefault(); e.stopPropagation(); map.locate({setView: true, maxZoom: 15}); }
                            return container;
                        }
                    });
                    mapInstance.current.addControl(new LocateControl());
                    mapInstance.current.on('locationfound', function(e) {
                        userLocationRef.current = e.latlng;
                        if (window.currentUserLayer) mapInstance.current.removeLayer(window.currentUserLayer);
                        const radius = e.accuracy / 2;
                        window.currentUserLayer = L.layerGroup([
                            L.marker(e.latlng).bindPopup(`<b>You are here</b>`).openPopup(),
                            L.circle(e.latlng, radius)
                        ]).addTo(mapInstance.current);
                    });
                    window.drawRouteTo = (lat, lng) => {
                        if (!userLocationRef.current) return alert("Please click the 'Crosshair' button first!");
                        if (routingControlRef.current) mapInstance.current.removeControl(routingControlRef.current);
                        routingControlRef.current = L.Routing.control({ waypoints: [L.latLng(userLocationRef.current), L.latLng(lat, lng)], lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 5}] }, createMarker: () => null, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true }).addTo(mapInstance.current);
                    };
                }
                if(mapInstance.current && stations.length > 0) {
                    mapInstance.current.eachLayer(layer => {
                        if(layer instanceof L.Marker && layer !== window.currentUserLayer) mapInstance.current.removeLayer(layer);
                    });
                    stations.forEach(s => {
                        if(s.lat && s.lng) {
                            const color = s.bikes > 0 ? '#10b981' : '#ef4444';
                            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="station-dot" style="background-color: ${color};"></div>`, iconSize: [12, 12], iconAnchor: [6, 6] });
                            const popupContent = `<div class="text-center p-1"><div class="font-bold text-sm mb-1">${s.name}</div><div class="text-xs mb-2 ${s.bikes > 0 ? 'text-green-600' : 'text-red-600'} font-bold">${s.bikes} Bikes Available</div><button onclick="window.drawRouteTo(${s.lat}, ${s.lng})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded shadow transition"><i class="fa-solid fa-diamond-turn-right mr-1"></i> Get Directions</button></div>`;
                            L.marker([s.lat, s.lng], { icon: icon }).bindPopup(popupContent).addTo(mapInstance.current);
                        }
                    });
                }
            }, [stations]);
            return (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mt-6">
                    <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-gray-700"><i className="fa-solid fa-map-location-dot mr-2 text-blue-500"></i>Live Bike Stations</h3><span className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">{stations.length} Stations</span></div>
                    <div ref={mapRef} className="h-[600px] w-full rounded-xl z-0 border border-gray-100" />
                </div>
            );
        }

        function Dashboard({ user, onLogout }) {
            const [data, setData] = React.useState(null);
            const [camStatus, setCamStatus] = React.useState("STOPPED");
            const [dataStatus, setDataStatus] = React.useState("STOPPED");
            React.useEffect(() => {
                const ref = db.ref('live_dashboard');
                ref.on('value', (snapshot) => setData(snapshot.val()));
                return () => ref.off();
            }, []);
            const toggleSensor = async (type, currentStatus, setStatus) => {
                const action = currentStatus === "STOPPED" ? "start" : "stop";
                setStatus("LOADING...");
                try {
                    const res = await fetch('/api/control', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: type, action: action })
                    });
                    const json = await res.json();
                    setStatus(json.status === "started" || json.status === "already_running" ? "RUNNING" : "STOPPED");
                } catch { setStatus("STOPPED"); }
            };
            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 font-sans">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex items-center gap-3 mb-4 md:mb-0"><div className="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200"><i className="fa-solid fa-city"></i></div><div><h1 className="font-bold text-xl text-slate-800 leading-none">Urban Advisor</h1><p className="text-xs text-slate-500 mt-1">Real-time Sensor Fusion</p></div></div>
                        <div className="flex items-center gap-4"><div className="text-right hidden md:block"><div className="text-xs text-gray-400 uppercase font-bold">Logged in as</div><div className="text-sm font-medium text-gray-700">{user}</div></div><button onClick={onLogout} className="text-red-500 font-bold text-sm hover:bg-red-50 px-3 py-2 rounded-lg transition"><i className="fa-solid fa-arrow-right-from-bracket mr-2"></i>Logout</button></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-3 space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="text-sm font-bold text-gray-400 uppercase mb-4 tracking-wider">Control Center</h2>
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100"><div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2"><i className="fa-solid fa-video text-slate-400"></i><span className="font-bold text-slate-700 text-sm">Motion Sensor</span></div><span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase ${camStatus==="RUNNING"?"bg-green-100 text-green-700":"bg-slate-200 text-slate-500"}`}>{camStatus}</span></div><button onClick={() => toggleSensor('webcam', camStatus, setCamStatus)} className={`w-full py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95 ${camStatus==="STOPPED" ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-white text-red-600 border border-red-200 hover:bg-red-50"}`}>{camStatus==="STOPPED" ? "Start Camera" : "Stop Camera"}</button></div>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100"><div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2"><i className="fa-solid fa-server text-slate-400"></i><span className="font-bold text-slate-700 text-sm">Data Stream</span></div><span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase ${dataStatus==="RUNNING"?"bg-green-100 text-green-700":"bg-slate-200 text-slate-500"}`}>{dataStatus}</span></div><button onClick={() => toggleSensor('opendata', dataStatus, setDataStatus)} className={`w-full py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95 ${dataStatus==="STOPPED" ? "bg-purple-600 text-white hover:bg-purple-700" : "bg-white text-red-600 border border-red-200 hover:bg-red-50"}`}>{dataStatus==="STOPPED" ? "Start Stream" : "Stop Stream"}</button></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><h2 className="text-sm font-bold text-gray-400 uppercase mb-4 tracking-wider">AI Analysis</h2><p className="text-sm text-slate-600 leading-relaxed">{data?.analysis?.pattern_insight || "Waiting for data patterns..."}</p></div>
                        </div>
                        <div className="lg:col-span-9 space-y-6">
                            {data ? (
                                <>
                                    <div className={`relative overflow-hidden p-8 rounded-2xl shadow-lg text-white transition-all duration-500 ${data.text === "GO OUTSIDE" ? "bg-gradient-to-r from-emerald-500 to-teal-600" : "bg-gradient-to-r from-rose-500 to-pink-600"}`}>
                                        <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2"><span className="bg-white/20 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider backdrop-blur-sm">Recommendation</span><span className="text-xs opacity-75"><i className="fa-regular fa-clock mr-1"></i>{data.last_updated}</span></div>
                                                <h2 className="text-5xl md:text-6xl font-black tracking-tight mb-2">{data.text}</h2>
                                                <p className="text-lg opacity-90 font-medium max-w-xl">{data.reason}</p>
                                            </div>
                                            <div className="bg-white/20 p-4 rounded-2xl backdrop-blur-md text-center min-w-[120px]"><div className="text-xs font-bold uppercase opacity-75 mb-1">Score</div><div className="text-4xl font-black">{data.score}</div><div className="text-xs opacity-75">out of 100</div></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <MetricCard icon="fa-temperature-half" label="Temp" value={data.metrics?.temperature} color="text-orange-500" bg="bg-orange-50" />
                                        <MetricCard icon="fa-wind" label="AQI" value={"AQI " + data.metrics?.aqi} color="text-blue-500" bg="bg-blue-50" />
                                        <MetricCard icon="fa-bicycle" label="Dublin Bikes" value={data.metrics?.bikes_available} color="text-purple-500" bg="bg-purple-50" />
                                        <MetricCard icon="fa-cloud" label="Weather" value={data.metrics?.weather} color="text-gray-500" bg="bg-gray-50" />
                                    </div>
                                    <BikeMap />
                                </>
                            ) : (
                                <div className="bg-white p-16 rounded-2xl text-center shadow-sm border border-slate-200"><div className="inline-block p-4 rounded-full bg-blue-50 text-blue-500 mb-4 animate-bounce"><i className="fa-solid fa-satellite-dish text-2xl"></i></div><h3 className="text-xl font-bold text-gray-800">Waiting for Data Fusion...</h3><p className="text-gray-500 mt-2">Please ensure the backend server and data collectors are running.</p></div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function MetricCard({icon, label, value, color, bg}) {
            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 transition hover:shadow-md">
                    <div className={`text-2xl w-12 h-12 flex items-center justify-center rounded-xl ${bg} ${color}`}> <i className={`fa-solid ${icon}`}></i></div>
                    <div><div className="text-[10px] text-gray-400 uppercase font-bold tracking-wide">{label}</div><div className="text-lg font-bold text-slate-700">{value || "--"}</div></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
